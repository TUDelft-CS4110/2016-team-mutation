<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>VirtualRoutingResourceTest.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">cloud-core (18-mrt-2016 13:14:54)</a> &gt; <a href="../../index.html" class="el_group">cloud-core</a> &gt; <a href="../index.html" class="el_bundle">test</a> &gt; <a href="index.source.html" class="el_package">com.cloud.agent.resource.virtualnetwork</a> &gt; <span class="el_source">VirtualRoutingResourceTest.java</span></div><h1>VirtualRoutingResourceTest.java</h1><pre class="source lang-java linenums">//
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// &quot;License&quot;); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.
//

package com.cloud.agent.resource.virtualnetwork;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;
import static org.junit.Assert.fail;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.UUID;

import javax.naming.ConfigurationException;

import org.junit.Before;
import org.junit.Ignore;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.test.context.support.AnnotationConfigContextLoader;

import com.cloud.agent.api.Answer;
import com.cloud.agent.api.BumpUpPriorityCommand;
import com.cloud.agent.api.SetupGuestNetworkCommand;
import com.cloud.agent.api.routing.AggregationControlCommand;
import com.cloud.agent.api.routing.AggregationControlCommand.Action;
import com.cloud.agent.api.routing.CreateIpAliasCommand;
import com.cloud.agent.api.routing.DeleteIpAliasCommand;
import com.cloud.agent.api.routing.DhcpEntryCommand;
import com.cloud.agent.api.routing.DnsMasqConfigCommand;
import com.cloud.agent.api.routing.GroupAnswer;
import com.cloud.agent.api.routing.IpAliasTO;
import com.cloud.agent.api.routing.IpAssocCommand;
import com.cloud.agent.api.routing.IpAssocVpcCommand;
import com.cloud.agent.api.routing.LoadBalancerConfigCommand;
import com.cloud.agent.api.routing.NetworkElementCommand;
import com.cloud.agent.api.routing.RemoteAccessVpnCfgCommand;
import com.cloud.agent.api.routing.SavePasswordCommand;
import com.cloud.agent.api.routing.SetFirewallRulesCommand;
import com.cloud.agent.api.routing.SetMonitorServiceCommand;
import com.cloud.agent.api.routing.SetNetworkACLCommand;
import com.cloud.agent.api.routing.SetPortForwardingRulesCommand;
import com.cloud.agent.api.routing.SetPortForwardingRulesVpcCommand;
import com.cloud.agent.api.routing.SetSourceNatCommand;
import com.cloud.agent.api.routing.SetStaticNatRulesCommand;
import com.cloud.agent.api.routing.SetStaticRouteCommand;
import com.cloud.agent.api.routing.Site2SiteVpnCfgCommand;
import com.cloud.agent.api.routing.VmDataCommand;
import com.cloud.agent.api.routing.VpnUsersCfgCommand;
import com.cloud.agent.api.to.DhcpTO;
import com.cloud.agent.api.to.FirewallRuleTO;
import com.cloud.agent.api.to.IpAddressTO;
import com.cloud.agent.api.to.LoadBalancerTO;
import com.cloud.agent.api.to.MonitorServiceTO;
import com.cloud.agent.api.to.NetworkACLTO;
import com.cloud.agent.api.to.NicTO;
import com.cloud.agent.api.to.PortForwardingRuleTO;
import com.cloud.network.lb.LoadBalancingRule.LbDestination;
import com.cloud.network.rules.FirewallRule.Purpose;
import com.cloud.network.vpc.NetworkACLItem.TrafficType;
import com.cloud.network.vpc.VpcGateway;
import com.cloud.utils.ExecutionResult;
import com.cloud.utils.net.NetUtils;

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(loader = AnnotationConfigContextLoader.class)
@Ignore(&quot;Just forget until the rewrite is a little more done&quot;)
<span class="nc" id="L88">public class VirtualRoutingResourceTest implements VirtualRouterDeployer {</span>
    VirtualRoutingResource _resource;
    NetworkElementCommand _currentCmd;
    int _count;
    String _file;

<span class="nc" id="L94">    String ROUTERIP = &quot;169.254.3.4&quot;;</span>
<span class="nc" id="L95">    String ROUTERGUESTIP = &quot;10.200.1.1&quot;;</span>
<span class="nc" id="L96">    String ROUTERNAME = &quot;r-4-VM&quot;;</span>

    @Override
    public ExecutionResult executeInVR(final String routerIp, final String script, final String args) {
<span class="nc" id="L100">        return executeInVR(routerIp, script, args, 60);</span>
    }

    @Override
    public ExecutionResult executeInVR(final String routerIp, final String script, final String args, final int timeout) {
<span class="nc" id="L105">        assertEquals(routerIp, ROUTERIP);</span>
<span class="nc" id="L106">        verifyCommand(_currentCmd, script, args);</span>
<span class="nc" id="L107">        return new ExecutionResult(true, null);</span>
    }

    @Override
    public ExecutionResult createFileInVR(final String routerIp, final String path, final String filename, final String content) {
<span class="nc" id="L112">        assertEquals(routerIp, ROUTERIP);</span>
<span class="nc" id="L113">        verifyFile(_currentCmd, path, filename, content);</span>
<span class="nc" id="L114">        return new ExecutionResult(true, null);</span>
    }

    @Override
    public ExecutionResult prepareCommand(final NetworkElementCommand cmd) {
<span class="nc" id="L119">        cmd.setRouterAccessIp(ROUTERIP);</span>
<span class="nc" id="L120">        _currentCmd = cmd;</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (cmd instanceof IpAssocVpcCommand) {</span>
<span class="nc" id="L122">            return prepareNetworkElementCommand((IpAssocVpcCommand)cmd);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        } else if (cmd instanceof IpAssocCommand) {</span>
<span class="nc" id="L124">            return prepareNetworkElementCommand((IpAssocCommand)cmd);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">        } else if (cmd instanceof SetupGuestNetworkCommand) {</span>
<span class="nc" id="L126">            return prepareNetworkElementCommand((SetupGuestNetworkCommand)cmd);</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">        } else if (cmd instanceof SetSourceNatCommand) {</span>
<span class="nc" id="L128">            return prepareNetworkElementCommand((SetSourceNatCommand)cmd);</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        } else if (cmd instanceof SetNetworkACLCommand) {</span>
<span class="nc" id="L130">            return prepareNetworkElementCommand((SetNetworkACLCommand)cmd);</span>
        }
<span class="nc" id="L132">        return new ExecutionResult(true, null);</span>
    }

    @Override
    public ExecutionResult cleanupCommand(final NetworkElementCommand cmd) {
<span class="nc" id="L137">        return new ExecutionResult(true, null);</span>
    }

    @Before
    public void setup() {
<span class="nc" id="L142">        _resource = new VirtualRoutingResource(this);</span>
        try {
<span class="nc" id="L144">            _resource.configure(&quot;VRResource&quot;, new HashMap&lt;String, Object&gt;());</span>
<span class="nc" id="L145">        } catch (final ConfigurationException e) {</span>
<span class="nc" id="L146">            e.printStackTrace();</span>
        }
<span class="nc" id="L148">    }</span>

    private void verifyFile(final NetworkElementCommand cmd, final String path, final String filename, final String content) {
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (cmd instanceof AggregationControlCommand) {</span>
<span class="nc" id="L152">            verifyFile(cmd, path, filename, content);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        } else if (cmd instanceof LoadBalancerConfigCommand) {</span>
<span class="nc" id="L154">            verifyFile((LoadBalancerConfigCommand)cmd, path, filename, content);</span>
        }
<span class="nc" id="L156">    }</span>

    protected void verifyCommand(final NetworkElementCommand cmd, final String script, final String args) {
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (cmd instanceof SetStaticRouteCommand) {</span>
<span class="nc" id="L160">            verifyArgs((SetStaticRouteCommand) cmd, script, args);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">        } else if (cmd instanceof SetStaticNatRulesCommand) {</span>
<span class="nc" id="L162">            verifyArgs((SetStaticNatRulesCommand) cmd, script, args);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        } else if (cmd instanceof LoadBalancerConfigCommand) {</span>
<span class="nc" id="L164">            verifyArgs((LoadBalancerConfigCommand) cmd, script, args);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        } else if (cmd instanceof SavePasswordCommand) {</span>
<span class="nc" id="L166">            verifyArgs((SavePasswordCommand)cmd, script, args);</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">        } else if (cmd instanceof DhcpEntryCommand) {</span>
<span class="nc" id="L168">            verifyArgs((DhcpEntryCommand)cmd, script, args);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        } else if (cmd instanceof DnsMasqConfigCommand) {</span>
<span class="nc" id="L170">            verifyArgs((DnsMasqConfigCommand)cmd, script, args);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        } else if (cmd instanceof VmDataCommand) {</span>
<span class="nc" id="L172">            verifyArgs((VmDataCommand)cmd, script, args);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">        } else if (cmd instanceof RemoteAccessVpnCfgCommand) {</span>
<span class="nc" id="L174">            verifyArgs((RemoteAccessVpnCfgCommand)cmd, script, args);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        } else if (cmd instanceof VpnUsersCfgCommand) {</span>
<span class="nc" id="L176">            verifyArgs((VpnUsersCfgCommand)cmd, script, args);</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">        } else if (cmd instanceof Site2SiteVpnCfgCommand) {</span>
<span class="nc" id="L178">            verifyArgs((Site2SiteVpnCfgCommand)cmd, script, args);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        } else if (cmd instanceof SetMonitorServiceCommand) {</span>
<span class="nc" id="L180">            verifyArgs((SetMonitorServiceCommand)cmd, script, args);</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">        } else if (cmd instanceof SetupGuestNetworkCommand) {</span>
<span class="nc" id="L182">            verifyArgs((SetupGuestNetworkCommand)cmd, script, args);</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        } else if (cmd instanceof SetNetworkACLCommand) {</span>
<span class="nc" id="L184">            verifyArgs((SetNetworkACLCommand)cmd, script, args);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        } else if (cmd instanceof SetSourceNatCommand) {</span>
<span class="nc" id="L186">            verifyArgs((SetSourceNatCommand)cmd, script, args);</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">        } else if (cmd instanceof IpAssocCommand) {</span>
<span class="nc" id="L188">            verifyArgs((IpAssocCommand)cmd, script, args);</span>
        }

<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (cmd instanceof AggregationControlCommand) {</span>
<span class="nc" id="L192">            verifyArgs((AggregationControlCommand)cmd, script, args);</span>
        }
<span class="nc" id="L194">    }</span>

    private void verifyArgs(final VpnUsersCfgCommand cmd, final String script, final String args) {
        //To change body of created methods use File | Settings | File Templates.
<span class="nc" id="L198">    }</span>

    private void verifyArgs(final SetStaticRouteCommand cmd, final String script, final String args) {
        //To change body of created methods use File | Settings | File Templates.
<span class="nc" id="L202">    }</span>

    private void verifyArgs(final SetStaticNatRulesCommand cmd, final String script, final String args) {
        //To change body of created methods use File | Settings | File Templates.
<span class="nc" id="L206">    }</span>

    @Test
    public void testBumpUpCommand() {
<span class="nc" id="L210">        final BumpUpPriorityCommand cmd = new BumpUpPriorityCommand();</span>
<span class="nc" id="L211">        final Answer answer = _resource.executeRequest(cmd);</span>
<span class="nc" id="L212">        assertTrue(answer.getResult());</span>
<span class="nc" id="L213">    }</span>

    @Test
    public void testSetPortForwardingRulesVpcCommand() {
<span class="nc" id="L217">        final SetPortForwardingRulesVpcCommand cmd = generateSetPortForwardingRulesVpcCommand();</span>

        // Reset rule check count
<span class="nc" id="L220">        _count = 0;</span>

<span class="nc" id="L222">        final Answer answer = _resource.executeRequest(cmd);</span>
<span class="nc" id="L223">        assertTrue(answer instanceof GroupAnswer);</span>
<span class="nc" id="L224">        assertEquals(((GroupAnswer) answer).getResults().length, 2);</span>
<span class="nc" id="L225">        assertTrue(answer.getResult());</span>
<span class="nc" id="L226">    }</span>

    protected SetPortForwardingRulesVpcCommand generateSetPortForwardingRulesVpcCommand() {
<span class="nc" id="L229">        final List&lt;PortForwardingRuleTO&gt; pfRules = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L230">        pfRules.add(new PortForwardingRuleTO(1, &quot;64.1.1.10&quot;, 22, 80, &quot;10.10.1.10&quot;, 22, 80, &quot;TCP&quot;, false, false));</span>
<span class="nc" id="L231">        pfRules.add(new PortForwardingRuleTO(2, &quot;64.1.1.11&quot;, 8080, 8080, &quot;10.10.1.11&quot;, 8080, 8080, &quot;UDP&quot;, true, false));</span>
<span class="nc" id="L232">        final SetPortForwardingRulesVpcCommand cmd = new SetPortForwardingRulesVpcCommand(pfRules);</span>
<span class="nc" id="L233">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L234">        assertEquals(cmd.getAnswersCount(), 2);</span>
<span class="nc" id="L235">        return cmd;</span>
    }

    @Test
    public void testSetPortForwardingRulesCommand() {
<span class="nc" id="L240">        final SetPortForwardingRulesCommand cmd = generateSetPortForwardingRulesCommand();</span>
        // Reset rule check count
<span class="nc" id="L242">        _count = 0;</span>

<span class="nc" id="L244">        final Answer answer = _resource.executeRequest(cmd);</span>
<span class="nc" id="L245">        assertTrue(answer instanceof GroupAnswer);</span>
<span class="nc" id="L246">        assertEquals(((GroupAnswer) answer).getResults().length, 2);</span>
<span class="nc" id="L247">        assertTrue(answer.getResult());</span>
<span class="nc" id="L248">    }</span>

    protected SetPortForwardingRulesCommand generateSetPortForwardingRulesCommand() {
<span class="nc" id="L251">        final List&lt;PortForwardingRuleTO&gt; pfRules = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L252">        pfRules.add(new PortForwardingRuleTO(1, &quot;64.1.1.10&quot;, 22, 80, &quot;10.10.1.10&quot;, 22, 80, &quot;TCP&quot;, false, false));</span>
<span class="nc" id="L253">        pfRules.add(new PortForwardingRuleTO(2, &quot;64.1.1.11&quot;, 8080, 8080, &quot;10.10.1.11&quot;, 8080, 8080, &quot;UDP&quot;, true, false));</span>
<span class="nc" id="L254">        final SetPortForwardingRulesCommand cmd = new SetPortForwardingRulesCommand(pfRules);</span>
<span class="nc" id="L255">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L256">        assertEquals(cmd.getAnswersCount(), 2);</span>
<span class="nc" id="L257">        return cmd;</span>
    }

    @Test
    public void testIpAssocCommand() {
<span class="nc" id="L262">        final IpAssocCommand cmd = generateIpAssocCommand();</span>
<span class="nc" id="L263">        _count = 0;</span>

<span class="nc" id="L265">        final Answer answer = _resource.executeRequest(cmd);</span>
<span class="nc" id="L266">        assertTrue(answer instanceof GroupAnswer);</span>
<span class="nc" id="L267">        assertEquals(2, ((GroupAnswer)answer).getResults().length);</span>
<span class="nc" id="L268">        assertTrue(answer.getResult());</span>

<span class="nc" id="L270">    }</span>

    private ExecutionResult prepareNetworkElementCommand(final IpAssocCommand cmd) {
<span class="nc" id="L273">        final IpAddressTO[] ips = cmd.getIpAddresses();</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">        for (final IpAddressTO ip : ips) {</span>
<span class="nc" id="L275">            ip.setNicDevId(2);</span>
        }
<span class="nc" id="L277">        return new ExecutionResult(true, null);</span>
    }

    protected IpAssocCommand generateIpAssocCommand() {
<span class="nc" id="L281">        final List&lt;IpAddressTO&gt; ips = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L282">        ips.add(new IpAddressTO(1, &quot;64.1.1.10&quot;, true, true, true, &quot;vlan://64&quot;, &quot;64.1.1.1&quot;, &quot;255.255.255.0&quot;, &quot;01:23:45:67:89:AB&quot;, 1000, false));</span>
<span class="nc" id="L283">        ips.add(new IpAddressTO(2, &quot;64.1.1.11&quot;, false, false, false, &quot;vlan://64&quot;, &quot;64.1.1.1&quot;, &quot;255.255.255.0&quot;, &quot;01:23:45:67:89:AB&quot;, 1000, false));</span>
<span class="nc" id="L284">        ips.add(new IpAddressTO(3, &quot;65.1.1.11&quot;, true, false, false, &quot;vlan://65&quot;, &quot;65.1.1.1&quot;, &quot;255.255.255.0&quot;, &quot;11:23:45:67:89:AB&quot;, 1000, false));</span>
<span class="nc" id="L285">        final IpAddressTO[] ipArray = ips.toArray(new IpAddressTO[ips.size()]);</span>
<span class="nc" id="L286">        final IpAssocCommand cmd = new IpAssocCommand(ipArray);</span>
<span class="nc" id="L287">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L288">        assertEquals(cmd.getAnswersCount(), 3);</span>

<span class="nc" id="L290">        return cmd;</span>
    }

    @Test
    public void testIpAssocVpcCommand() {
<span class="nc" id="L295">        final IpAssocVpcCommand cmd = generateIpAssocVpcCommand();</span>
<span class="nc" id="L296">        _count = 0;</span>

<span class="nc" id="L298">        final Answer answer = _resource.executeRequest(cmd);</span>
<span class="nc" id="L299">        assertTrue(answer instanceof GroupAnswer);</span>
<span class="nc" id="L300">        assertEquals(2, ((GroupAnswer)answer).getResults().length);</span>
<span class="nc" id="L301">        assertTrue(answer.getResult());</span>

<span class="nc" id="L303">    }</span>

    private ExecutionResult prepareNetworkElementCommand(final IpAssocVpcCommand cmd) {
<span class="nc" id="L306">        final IpAddressTO[] ips = cmd.getIpAddresses();</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">        for (final IpAddressTO ip : ips) {</span>
<span class="nc" id="L308">            ip.setNicDevId(2);</span>
        }
<span class="nc" id="L310">        return new ExecutionResult(true, null);</span>
    }

    protected IpAssocVpcCommand generateIpAssocVpcCommand() {
<span class="nc" id="L314">        final List&lt;IpAddressTO&gt; ips = new ArrayList&lt;IpAddressTO&gt;();</span>
<span class="nc" id="L315">        ips.add(new IpAddressTO(1, &quot;64.1.1.10&quot;, true, true, true, &quot;vlan://64&quot;, &quot;64.1.1.1&quot;, &quot;255.255.255.0&quot;, &quot;01:23:45:67:89:AB&quot;, 1000, false));</span>
<span class="nc" id="L316">        ips.add(new IpAddressTO(2, &quot;64.1.1.11&quot;, false, false, true, &quot;vlan://64&quot;, &quot;64.1.1.1&quot;, &quot;255.255.255.0&quot;, &quot;01:23:45:67:89:AB&quot;, 1000, false));</span>
<span class="nc" id="L317">        ips.add(new IpAddressTO(3, &quot;65.1.1.11&quot;, true, false, false, &quot;vlan://65&quot;, &quot;65.1.1.1&quot;, &quot;255.255.255.0&quot;, &quot;11:23:45:67:89:AB&quot;, 1000, false));</span>
<span class="nc" id="L318">        final IpAddressTO[] ipArray = ips.toArray(new IpAddressTO[ips.size()]);</span>
<span class="nc" id="L319">        final IpAssocVpcCommand cmd = new IpAssocVpcCommand(ipArray);</span>
<span class="nc" id="L320">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L321">        assertEquals(6, cmd.getAnswersCount()); // AnswersCount is clearly wrong as it doesn't know enough to tell</span>

<span class="nc" id="L323">        return cmd;</span>
    }

    private void verifyArgs(final IpAssocCommand cmd, final String script, final String args) {
<span class="nc bnc" id="L327" title="All 2 branches missed.">        if (cmd instanceof IpAssocVpcCommand) {</span>
<span class="nc" id="L328">            _count ++;</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">            switch (_count) {</span>
            case 1:
<span class="nc" id="L331">                assertEquals(VRScripts.UPDATE_CONFIG, script);</span>
<span class="nc" id="L332">                assertEquals(VRScripts.IP_ASSOCIATION_CONFIG, args);</span>
<span class="nc" id="L333">                break;</span>
            default:
<span class="nc" id="L335">                fail(&quot;Failed to recongize the match!&quot;);</span>
            }
<span class="nc" id="L337">        } else {</span>
<span class="nc" id="L338">            assertEquals(script, VRScripts.UPDATE_CONFIG);</span>
<span class="nc" id="L339">            _count ++;</span>
<span class="nc bnc" id="L340" title="All 4 branches missed.">            switch (_count) {</span>
            case 1:
<span class="nc" id="L342">                assertEquals(VRScripts.IP_ASSOCIATION_CONFIG, args);</span>
<span class="nc" id="L343">                break;</span>
            case 2:
<span class="nc" id="L345">                assertEquals(VRScripts.IP_ASSOCIATION_CONFIG, args);</span>
<span class="nc" id="L346">                break;</span>
            case 3:
<span class="nc" id="L348">                assertEquals(VRScripts.IP_ASSOCIATION_CONFIG, args);</span>
<span class="nc" id="L349">                break;</span>
            default:
<span class="nc" id="L351">                fail(&quot;Failed to recongize the match!&quot;);</span>
            }
        }
<span class="nc" id="L354">    }</span>

    @Test
    public void testSourceNatCommand() {
<span class="nc" id="L358">        final SetSourceNatCommand cmd = generateSetSourceNatCommand();</span>
<span class="nc" id="L359">        final Answer answer = _resource.executeRequest(cmd);</span>
<span class="nc" id="L360">        assertTrue(answer.getResult());</span>
<span class="nc" id="L361">    }</span>

    private ExecutionResult prepareNetworkElementCommand(final SetSourceNatCommand cmd) {
<span class="nc" id="L364">        final IpAddressTO ip = cmd.getIpAddress();</span>
<span class="nc" id="L365">        ip.setNicDevId(1);</span>
<span class="nc" id="L366">        return new ExecutionResult(true, null);</span>
    }

    protected SetSourceNatCommand generateSetSourceNatCommand() {
<span class="nc" id="L370">        final IpAddressTO ip = new IpAddressTO(1, &quot;64.1.1.10&quot;, true, true, true, &quot;vlan://64&quot;, &quot;64.1.1.1&quot;, &quot;255.255.255.0&quot;, &quot;01:23:45:67:89:AB&quot;, 1000, false);</span>
<span class="nc" id="L371">        final SetSourceNatCommand cmd = new SetSourceNatCommand(ip, true);</span>
<span class="nc" id="L372">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L373">        return cmd;</span>
    }

    private void verifyArgs(final SetSourceNatCommand cmd, final String script, final String args) {
<span class="nc" id="L377">        assertEquals(script, VRScripts.VPC_SOURCE_NAT);</span>
<span class="nc" id="L378">        assertEquals(args, &quot;-A -l 64.1.1.10 -c eth1&quot;);</span>
<span class="nc" id="L379">    }</span>

    @Test
    public void testNetworkACLCommand() {
<span class="nc" id="L383">        final SetNetworkACLCommand cmd = generateSetNetworkACLCommand();</span>
<span class="nc" id="L384">        _count = 0;</span>

<span class="nc" id="L386">        Answer answer = _resource.executeRequest(cmd);</span>
<span class="nc" id="L387">        assertTrue(answer.getResult());</span>

<span class="nc" id="L389">        cmd.setAccessDetail(NetworkElementCommand.VPC_PRIVATE_GATEWAY, String.valueOf(VpcGateway.Type.Private));</span>
<span class="nc" id="L390">        answer = _resource.executeRequest(cmd);</span>
<span class="nc" id="L391">        assertTrue(answer.getResult());</span>
<span class="nc" id="L392">    }</span>

    protected SetNetworkACLCommand generateSetNetworkACLCommand() {
<span class="nc" id="L395">        final List&lt;NetworkACLTO&gt; acls = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L396">        final List&lt;String&gt; cidrs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L397">        cidrs.add(&quot;192.168.0.1/24&quot;);</span>
<span class="nc" id="L398">        cidrs.add(&quot;192.168.0.2/24&quot;);</span>
<span class="nc" id="L399">        acls.add(new NetworkACLTO(1, &quot;64&quot;, &quot;TCP&quot;, 20, 80, false, false, cidrs, 0, 0, TrafficType.Ingress, true, 1));</span>
<span class="nc" id="L400">        acls.add(new NetworkACLTO(2, &quot;64&quot;, &quot;ICMP&quot;, 0, 0, false, false, cidrs, -1, -1, TrafficType.Ingress, false, 2));</span>
<span class="nc" id="L401">        acls.add(new NetworkACLTO(3, &quot;65&quot;, &quot;ALL&quot;, 0, 0, false, false, cidrs, -1, -1, TrafficType.Egress, true, 3));</span>
<span class="nc" id="L402">        final NicTO nic = new NicTO();</span>
<span class="nc" id="L403">        nic.setMac(&quot;01:23:45:67:89:AB&quot;);</span>
<span class="nc" id="L404">        nic.setIp(&quot;192.168.1.1&quot;);</span>
<span class="nc" id="L405">        nic.setNetmask(&quot;255.255.255.0&quot;);</span>
<span class="nc" id="L406">        final SetNetworkACLCommand cmd = new SetNetworkACLCommand(acls, nic);</span>
<span class="nc" id="L407">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>

<span class="nc" id="L409">        return cmd;</span>
    }

    private void verifyArgs(final SetNetworkACLCommand cmd, final String script, final String args) {
<span class="nc" id="L413">        _count ++;</span>
<span class="nc bnc" id="L414" title="All 3 branches missed.">        switch (_count) {</span>
        case 1:
            // FIXME Check the json content
<span class="nc" id="L417">            assertEquals(VRScripts.UPDATE_CONFIG, script);</span>
<span class="nc" id="L418">            assertEquals(VRScripts.NETWORK_ACL_CONFIG, args);</span>
            // assertEquals(args, &quot; -d eth3 -M 01:23:45:67:89:AB -i 192.168.1.1 -m 24 -a Egress:ALL:0:0:192.168.0.1/24-192.168.0.2/24:ACCEPT:,&quot; +
            //        &quot;Ingress:ICMP:0:0:192.168.0.1/24-192.168.0.2/24:DROP:,Ingress:TCP:20:80:192.168.0.1/24-192.168.0.2/24:ACCEPT:,&quot;);
<span class="nc" id="L421">            break;</span>
        case 2:
<span class="nc" id="L423">            assertEquals(VRScripts.UPDATE_CONFIG, script);</span>
<span class="nc" id="L424">            assertEquals(VRScripts.NETWORK_ACL_CONFIG, args);</span>
<span class="nc" id="L425">            break;</span>
        default:
<span class="nc" id="L427">            fail();</span>
        }
<span class="nc" id="L429">    }</span>

    private ExecutionResult prepareNetworkElementCommand(final SetNetworkACLCommand cmd) {
<span class="nc" id="L432">        final NicTO nic = cmd.getNic();</span>
<span class="nc" id="L433">        nic.setDeviceId(3);</span>
<span class="nc" id="L434">        return new ExecutionResult(true, null);</span>
    }

    @Test
    public void testSetupGuestNetworkCommand() {
<span class="nc" id="L439">        final SetupGuestNetworkCommand cmd = generateSetupGuestNetworkCommand();</span>
<span class="nc" id="L440">        final Answer answer = _resource.executeRequest(cmd);</span>
<span class="nc" id="L441">        assertTrue(answer.getResult());</span>
<span class="nc" id="L442">    }</span>

    private ExecutionResult prepareNetworkElementCommand(final SetupGuestNetworkCommand cmd) {
<span class="nc" id="L445">        final NicTO nic = cmd.getNic();</span>
<span class="nc" id="L446">        nic.setDeviceId(4);</span>
<span class="nc" id="L447">        return new ExecutionResult(true, null);</span>
    }

    protected SetupGuestNetworkCommand generateSetupGuestNetworkCommand() {
<span class="nc" id="L451">        final NicTO nic = new NicTO();</span>
<span class="nc" id="L452">        nic.setMac(&quot;01:23:45:67:89:AB&quot;);</span>
<span class="nc" id="L453">        nic.setIp(&quot;10.1.1.1&quot;);</span>
<span class="nc" id="L454">        nic.setNetmask(&quot;255.255.255.0&quot;);</span>

<span class="nc" id="L456">        final SetupGuestNetworkCommand cmd = new SetupGuestNetworkCommand(&quot;10.1.1.10-10.1.1.20&quot;, &quot;cloud.test&quot;, false, &quot;8.8.8.8&quot;, &quot;8.8.4.4&quot;, true, nic);</span>
<span class="nc" id="L457">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_GUEST_IP, &quot;10.1.1.2&quot;);</span>
<span class="nc" id="L458">        cmd.setAccessDetail(NetworkElementCommand.GUEST_NETWORK_GATEWAY, &quot;10.1.1.1&quot;);</span>
<span class="nc" id="L459">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>

<span class="nc" id="L461">        return cmd;</span>
    }

    private void verifyArgs(final SetupGuestNetworkCommand cmd, final String script, final String args) {
        // TODO Check the contents of the json file
        //assertEquals(script, VRScripts.VPC_GUEST_NETWORK);
        //assertEquals(args, &quot; -C -M 01:23:45:67:89:AB -d eth4 -i 10.1.1.2 -g 10.1.1.1 -m 24 -n 10.1.1.0 -s 8.8.8.8,8.8.4.4 -e cloud.test&quot;);
<span class="nc" id="L468">    }</span>

    @Test
    public void testSetMonitorServiceCommand() {
<span class="nc" id="L472">        final SetMonitorServiceCommand cmd = generateSetMonitorServiceCommand();</span>
<span class="nc" id="L473">        final Answer answer = _resource.executeRequest(cmd);</span>
<span class="nc" id="L474">        assertTrue(answer.getResult());</span>
<span class="nc" id="L475">    }</span>

    protected SetMonitorServiceCommand generateSetMonitorServiceCommand() {
<span class="nc" id="L478">        final List&lt;MonitorServiceTO&gt; services = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L479">        services.add(new MonitorServiceTO(&quot;service&quot;, &quot;process&quot;, &quot;name&quot;, &quot;path&quot;, &quot;file&quot;, true));</span>
<span class="nc" id="L480">        services.add(new MonitorServiceTO(&quot;service_2&quot;, &quot;process_2&quot;, &quot;name_2&quot;, &quot;path_2&quot;, &quot;file_2&quot;, false));</span>

<span class="nc" id="L482">        final SetMonitorServiceCommand cmd = new SetMonitorServiceCommand(services);</span>
<span class="nc" id="L483">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>

<span class="nc" id="L485">        return cmd;</span>
    }

    private void verifyArgs(final SetMonitorServiceCommand cmd, final String script, final String args) {
<span class="nc" id="L489">        assertEquals(script, VRScripts.MONITOR_SERVICE);</span>
<span class="nc" id="L490">        assertEquals(args, &quot; -c [service]:processname=process:servicename=name:pidfile=file:,[service_2]:processname=process_2:servicename=name_2:pidfile=file_2:,&quot;);</span>
<span class="nc" id="L491">    }</span>

    @Test
    public void testSite2SiteVpnCfgCommand() {
<span class="nc" id="L495">        _count = 0;</span>

<span class="nc" id="L497">        Site2SiteVpnCfgCommand cmd = new Site2SiteVpnCfgCommand(true, &quot;64.10.1.10&quot;, &quot;64.10.1.1&quot;, &quot;192.168.1.1/16&quot;, &quot;124.10.1.10&quot;, &quot;192.168.100.1/24&quot;, &quot;3des-sha1,aes128-sha1;modp1536&quot;, &quot;3des-sha1,aes128-md5&quot;, &quot;psk&quot;, Long.valueOf(1800), Long.valueOf(1800), true, false, false);</span>
<span class="nc" id="L498">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L499">        Answer answer = _resource.executeRequest(cmd);</span>
<span class="nc" id="L500">        assertTrue(answer.getResult());</span>

<span class="nc" id="L502">        cmd = new Site2SiteVpnCfgCommand(true, &quot;64.10.1.10&quot;, &quot;64.10.1.1&quot;, &quot;192.168.1.1/16&quot;, &quot;124.10.1.10&quot;, &quot;192.168.100.1/24&quot;, &quot;3des-sha1,aes128-sha1;modp1536&quot;, &quot;3des-sha1,aes128-md5&quot;, &quot;psk&quot;, Long.valueOf(1800), Long.valueOf(1800), false, true, false);</span>
<span class="nc" id="L503">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L504">        answer = _resource.executeRequest(cmd);</span>
<span class="nc" id="L505">        assertTrue(answer.getResult());</span>

<span class="nc" id="L507">        cmd = new Site2SiteVpnCfgCommand(false, &quot;64.10.1.10&quot;, &quot;64.10.1.1&quot;, &quot;192.168.1.1/16&quot;, &quot;124.10.1.10&quot;, &quot;192.168.100.1/24&quot;, &quot;3des-sha1,aes128-sha1;modp1536&quot;, &quot;3des-sha1,aes128-md5&quot;, &quot;psk&quot;, Long.valueOf(1800), Long.valueOf(1800), false, true, false);</span>
<span class="nc" id="L508">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L509">        answer = _resource.executeRequest(cmd);</span>
<span class="nc" id="L510">        assertTrue(answer.getResult());</span>
<span class="nc" id="L511">    }</span>

    private void verifyArgs(final Site2SiteVpnCfgCommand cmd, final String script, final String args) {
<span class="nc" id="L514">        _count ++;</span>

<span class="nc" id="L516">        assertEquals(script, VRScripts.S2SVPN_IPSEC);</span>
<span class="nc bnc" id="L517" title="All 4 branches missed.">        switch (_count) {</span>
        case 1:
<span class="nc" id="L519">            assertEquals(args, &quot;-A -l 64.10.1.10 -n 192.168.1.1/16 -g 64.10.1.1 -r 124.10.1.10 -N 192.168.100.1/24 -e \&quot;3des-sha1,aes128-md5\&quot; -i \&quot;3des-sha1,aes128-sha1;modp1536\&quot; -t 1800 -T 1800 -s \&quot;psk\&quot; -d 1&quot;);</span>
<span class="nc" id="L520">            break;</span>
        case 2:
<span class="nc" id="L522">            assertEquals(args, &quot;-A -l 64.10.1.10 -n 192.168.1.1/16 -g 64.10.1.1 -r 124.10.1.10 -N 192.168.100.1/24 -e \&quot;3des-sha1,aes128-md5\&quot; -i \&quot;3des-sha1,aes128-sha1;modp1536\&quot; -t 1800 -T 1800 -s \&quot;psk\&quot; -d 0 -p &quot;);</span>
<span class="nc" id="L523">            break;</span>
        case 3:
<span class="nc" id="L525">            assertEquals(args, &quot;-D -r 124.10.1.10 -n 192.168.1.1/16 -N 192.168.100.1/24&quot;);</span>
<span class="nc" id="L526">            break;</span>
        default:
<span class="nc" id="L528">            fail();</span>
        }
<span class="nc" id="L530">    }</span>

    @Test
    public void testRemoteAccessVpnCfgCommand() {
<span class="nc" id="L534">        _count = 0;</span>

<span class="nc" id="L536">        Answer answer = _resource.executeRequest(generateRemoteAccessVpnCfgCommand1());</span>
<span class="nc" id="L537">        assertTrue(answer.getResult());</span>

<span class="nc" id="L539">        answer = _resource.executeRequest(generateRemoteAccessVpnCfgCommand2());</span>
<span class="nc" id="L540">        assertTrue(answer.getResult());</span>

<span class="nc" id="L542">        answer = _resource.executeRequest(generateRemoteAccessVpnCfgCommand3());</span>
<span class="nc" id="L543">        assertTrue(answer.getResult());</span>
<span class="nc" id="L544">    }</span>

    protected RemoteAccessVpnCfgCommand generateRemoteAccessVpnCfgCommand1() {
<span class="nc" id="L547">        final RemoteAccessVpnCfgCommand cmd = new RemoteAccessVpnCfgCommand(true, &quot;124.10.10.10&quot;, &quot;10.10.1.1&quot;, &quot;10.10.1.10-10.10.1.20&quot;, &quot;sharedkey&quot;, false);</span>
<span class="nc" id="L548">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L549">        cmd.setLocalCidr(&quot;10.1.1.1/24&quot;);</span>
<span class="nc" id="L550">        return cmd;</span>
    }

    protected RemoteAccessVpnCfgCommand generateRemoteAccessVpnCfgCommand2() {
<span class="nc" id="L554">        final RemoteAccessVpnCfgCommand cmd = new RemoteAccessVpnCfgCommand(false, &quot;124.10.10.10&quot;, &quot;10.10.1.1&quot;, &quot;10.10.1.10-10.10.1.20&quot;, &quot;sharedkey&quot;, false);</span>
<span class="nc" id="L555">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L556">        cmd.setLocalCidr(&quot;10.1.1.1/24&quot;);</span>
<span class="nc" id="L557">        return cmd;</span>
    }

    protected RemoteAccessVpnCfgCommand generateRemoteAccessVpnCfgCommand3() {
<span class="nc" id="L561">        final RemoteAccessVpnCfgCommand cmd = new RemoteAccessVpnCfgCommand(true, &quot;124.10.10.10&quot;, &quot;10.10.1.1&quot;, &quot;10.10.1.10-10.10.1.20&quot;, &quot;sharedkey&quot;, true);</span>
<span class="nc" id="L562">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L563">        cmd.setLocalCidr(&quot;10.1.1.1/24&quot;);</span>
<span class="nc" id="L564">        return cmd;</span>
    }

    private void verifyArgs(final RemoteAccessVpnCfgCommand cmd, final String script, final String args) {
<span class="nc" id="L568">        _count ++;</span>

<span class="nc" id="L570">        assertEquals(script, VRScripts.VPN_L2TP);</span>
<span class="nc bnc" id="L571" title="All 4 branches missed.">        switch (_count) {</span>
        case 1:
<span class="nc" id="L573">            assertEquals(args, &quot;-r 10.10.1.10-10.10.1.20 -p sharedkey -s 124.10.10.10 -l 10.10.1.1 -c  -C 10.1.1.1/24 -i eth2&quot;);</span>
<span class="nc" id="L574">            break;</span>
        case 2:
<span class="nc" id="L576">            assertEquals(args, &quot;-d  -s 124.10.10.10 -C 10.1.1.1/24 -i eth2&quot;);</span>
<span class="nc" id="L577">            break;</span>
        case 3:
<span class="nc" id="L579">            assertEquals(args, &quot;-r 10.10.1.10-10.10.1.20 -p sharedkey -s 124.10.10.10 -l 10.10.1.1 -c  -C 10.1.1.1/24 -i eth1&quot;);</span>
<span class="nc" id="L580">            break;</span>
        default:
<span class="nc" id="L582">            fail();</span>

        }
<span class="nc" id="L585">    }</span>

    @Test
    public void testFirewallRulesCommand() {
<span class="nc" id="L589">        _count = 0;</span>

<span class="nc" id="L591">        final Answer answer = _resource.executeRequest(generateSetFirewallRulesCommand());</span>
<span class="nc" id="L592">        assertTrue(answer.getResult());</span>

        //TODO Didn't test egress rule because not able to generate FirewallRuleVO object
<span class="nc" id="L595">    }</span>

    protected SetFirewallRulesCommand generateSetFirewallRulesCommand() {
<span class="nc" id="L598">        final List&lt;FirewallRuleTO&gt; rules = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L599">        final List&lt;String&gt; sourceCidrs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L600">        sourceCidrs.add(&quot;10.10.1.1/24&quot;);</span>
<span class="nc" id="L601">        sourceCidrs.add(&quot;10.10.1.2/24&quot;);</span>
<span class="nc" id="L602">        rules.add(new FirewallRuleTO(1, &quot;64.10.10.10&quot;, &quot;TCP&quot;, 22, 80, false, false, Purpose.Firewall, sourceCidrs, 0, 0));</span>
<span class="nc" id="L603">        rules.add(new FirewallRuleTO(2, &quot;64.10.10.10&quot;, &quot;ICMP&quot;, 0, 0, false, false, Purpose.Firewall, sourceCidrs, -1, -1));</span>
<span class="nc" id="L604">        rules.add(new FirewallRuleTO(3, &quot;64.10.10.10&quot;, &quot;ICMP&quot;, 0, 0, true, true, Purpose.Firewall, sourceCidrs, -1, -1));</span>
<span class="nc" id="L605">        final SetFirewallRulesCommand cmd = new SetFirewallRulesCommand(rules);</span>
<span class="nc" id="L606">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>

<span class="nc" id="L608">        return cmd;</span>
    }

    @Test
    public void testVmDataCommand() {
<span class="nc" id="L613">        final Answer answer = _resource.executeRequest(generateVmDataCommand());</span>
<span class="nc" id="L614">        assertTrue(answer.getResult());</span>
<span class="nc" id="L615">    }</span>

    protected VmDataCommand generateVmDataCommand() {
<span class="nc" id="L618">        final VmDataCommand cmd = new VmDataCommand(&quot;10.1.10.4&quot;, &quot;i-4-VM&quot;, true);</span>
        // if you add new metadata files, also edit systemvm/patches/debian/config/var/www/html/latest/.htaccess
<span class="nc" id="L620">        cmd.addVmData(&quot;userdata&quot;, &quot;user-data&quot;, &quot;user-data&quot;);</span>
<span class="nc" id="L621">        cmd.addVmData(&quot;metadata&quot;, &quot;service-offering&quot;, &quot;serviceOffering&quot;);</span>
<span class="nc" id="L622">        cmd.addVmData(&quot;metadata&quot;, &quot;availability-zone&quot;, &quot;zoneName&quot;);</span>
<span class="nc" id="L623">        cmd.addVmData(&quot;metadata&quot;, &quot;local-ipv4&quot;, &quot;10.1.10.4&quot;);</span>
<span class="nc" id="L624">        cmd.addVmData(&quot;metadata&quot;, &quot;local-hostname&quot;, &quot;test-vm&quot;);</span>
<span class="nc" id="L625">        cmd.addVmData(&quot;metadata&quot;, &quot;public-ipv4&quot;, &quot;110.1.10.4&quot;);</span>
<span class="nc" id="L626">        cmd.addVmData(&quot;metadata&quot;, &quot;public-hostname&quot;, &quot;hostname&quot;);</span>
<span class="nc" id="L627">        cmd.addVmData(&quot;metadata&quot;, &quot;instance-id&quot;, &quot;i-4-VM&quot;);</span>
<span class="nc" id="L628">        cmd.addVmData(&quot;metadata&quot;, &quot;vm-id&quot;, &quot;4&quot;);</span>
<span class="nc" id="L629">        cmd.addVmData(&quot;metadata&quot;, &quot;public-keys&quot;, &quot;publickey&quot;);</span>
<span class="nc" id="L630">        cmd.addVmData(&quot;metadata&quot;, &quot;cloud-identifier&quot;, &quot;CloudStack-{test}&quot;);</span>

<span class="nc" id="L632">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>

<span class="nc" id="L634">        return cmd;</span>
    }

    private void verifyArgs(final VmDataCommand cmd, final String script, final String args) {
<span class="nc" id="L638">        assertEquals(script, VRScripts.UPDATE_CONFIG);</span>
<span class="nc" id="L639">        assertEquals(args, VRScripts.VM_METADATA_CONFIG);</span>
<span class="nc" id="L640">    }</span>

    @Test
    public void testSavePasswordCommand() {
<span class="nc" id="L644">        final Answer answer = _resource.executeRequest(generateSavePasswordCommand());</span>
<span class="nc" id="L645">        assertTrue(answer.getResult());</span>
<span class="nc" id="L646">    }</span>

    protected SavePasswordCommand generateSavePasswordCommand() {
<span class="nc" id="L649">        final SavePasswordCommand cmd = new SavePasswordCommand(&quot;123pass&quot;, &quot;10.1.10.4&quot;, &quot;i-4-VM&quot;, true);</span>
<span class="nc" id="L650">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L651">        return cmd;</span>
    }

    private void verifyArgs(final SavePasswordCommand cmd, final String script, final String args) {
<span class="nc" id="L655">        assertEquals(script, VRScripts.PASSWORD);</span>
<span class="nc" id="L656">        assertEquals(args, &quot;-v 10.1.10.4 -p 123pass&quot;);</span>
<span class="nc" id="L657">    }</span>

    @Test
    public void testDhcpEntryCommand() {
<span class="nc" id="L661">        _count = 0;</span>

<span class="nc" id="L663">        Answer answer = _resource.executeRequest(generateDhcpEntryCommand1());</span>
<span class="nc" id="L664">        assertTrue(answer.getResult());</span>

<span class="nc" id="L666">        answer = _resource.executeRequest(generateDhcpEntryCommand2());</span>
<span class="nc" id="L667">        assertTrue(answer.getResult());</span>

<span class="nc" id="L669">        answer = _resource.executeRequest(generateDhcpEntryCommand3());</span>
<span class="nc" id="L670">        assertTrue(answer.getResult());</span>
<span class="nc" id="L671">    }</span>

    protected DhcpEntryCommand generateDhcpEntryCommand1() {
<span class="nc" id="L674">        final DhcpEntryCommand cmd = new DhcpEntryCommand(&quot;12:34:56:78:90:AB&quot;, &quot;10.1.10.2&quot;, &quot;vm1&quot;, null, true);</span>
<span class="nc" id="L675">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L676">        return cmd;</span>
    }

    protected DhcpEntryCommand generateDhcpEntryCommand2() {
<span class="nc" id="L680">        final DhcpEntryCommand cmd = new DhcpEntryCommand(&quot;12:34:56:78:90:AB&quot;, null, &quot;vm1&quot;, &quot;2001:db8:0:0:0:ff00:42:8329&quot;, true);</span>
<span class="nc" id="L681">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L682">        cmd.setDuid(NetUtils.getDuidLL(cmd.getVmMac()));</span>
<span class="nc" id="L683">        return cmd;</span>
    }

    protected DhcpEntryCommand generateDhcpEntryCommand3() {
<span class="nc" id="L687">        final DhcpEntryCommand cmd = new DhcpEntryCommand(&quot;12:34:56:78:90:AB&quot;, &quot;10.1.10.2&quot;, &quot;vm1&quot;, &quot;2001:db8:0:0:0:ff00:42:8329&quot;, true);</span>
<span class="nc" id="L688">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L689">        cmd.setDuid(NetUtils.getDuidLL(cmd.getVmMac()));</span>
<span class="nc" id="L690">        return cmd;</span>
    }

    private void verifyArgs(final DhcpEntryCommand cmd, final String script, final String args) {
<span class="nc" id="L694">        _count ++;</span>
<span class="nc" id="L695">        assertEquals(script, VRScripts.DHCP);</span>
<span class="nc bnc" id="L696" title="All 4 branches missed.">        switch (_count) {</span>
        case 1:
<span class="nc" id="L698">            assertEquals(args, &quot; -m 12:34:56:78:90:AB -4 10.1.10.2 -h vm1&quot;);</span>
<span class="nc" id="L699">            break;</span>
        case 2:
<span class="nc" id="L701">            assertEquals(args, &quot; -m 12:34:56:78:90:AB -h vm1 -6 2001:db8:0:0:0:ff00:42:8329 -u 00:03:00:01:12:34:56:78:90:AB&quot;);</span>
<span class="nc" id="L702">            break;</span>
        case 3:
<span class="nc" id="L704">            assertEquals(args, &quot; -m 12:34:56:78:90:AB -4 10.1.10.2 -h vm1 -6 2001:db8:0:0:0:ff00:42:8329 -u 00:03:00:01:12:34:56:78:90:AB&quot;);</span>
<span class="nc" id="L705">            break;</span>
        default:
<span class="nc" id="L707">            fail();</span>
        }
<span class="nc" id="L709">    }</span>

    @Test
    public void testCreateIpAliasCommand() {
<span class="nc" id="L713">        final Answer answer = _resource.executeRequest(generateCreateIpAliasCommand());</span>
<span class="nc" id="L714">        assertTrue(answer.getResult());</span>
<span class="nc" id="L715">    }</span>

    protected CreateIpAliasCommand generateCreateIpAliasCommand() {
<span class="nc" id="L718">        final List&lt;IpAliasTO&gt; aliases = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L719">        aliases.add(new IpAliasTO(&quot;169.254.3.10&quot;, &quot;255.255.255.0&quot;, &quot;1&quot;));</span>
<span class="nc" id="L720">        aliases.add(new IpAliasTO(&quot;169.254.3.11&quot;, &quot;255.255.255.0&quot;, &quot;2&quot;));</span>
<span class="nc" id="L721">        aliases.add(new IpAliasTO(&quot;169.254.3.12&quot;, &quot;255.255.255.0&quot;, &quot;3&quot;));</span>
<span class="nc" id="L722">        final CreateIpAliasCommand cmd = new CreateIpAliasCommand(&quot;169.254.3.10&quot;, aliases);</span>
<span class="nc" id="L723">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>

<span class="nc" id="L725">        return cmd;</span>
    }

    @Test
    public void testDeleteIpAliasCommand() {
<span class="nc" id="L730">        final Answer answer = _resource.executeRequest(generateDeleteIpAliasCommand());</span>
<span class="nc" id="L731">        assertTrue(answer.getResult());</span>
<span class="nc" id="L732">    }</span>

    protected DeleteIpAliasCommand generateDeleteIpAliasCommand() {
<span class="nc" id="L735">        final List&lt;IpAliasTO&gt; aliases = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L736">        aliases.add(new IpAliasTO(&quot;169.254.3.10&quot;, &quot;255.255.255.0&quot;, &quot;1&quot;));</span>
<span class="nc" id="L737">        aliases.add(new IpAliasTO(&quot;169.254.3.11&quot;, &quot;255.255.255.0&quot;, &quot;2&quot;));</span>
<span class="nc" id="L738">        aliases.add(new IpAliasTO(&quot;169.254.3.12&quot;, &quot;255.255.255.0&quot;, &quot;3&quot;));</span>
<span class="nc" id="L739">        final DeleteIpAliasCommand cmd = new DeleteIpAliasCommand(&quot;169.254.10.1&quot;, aliases, aliases);</span>
<span class="nc" id="L740">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L741">        return cmd;</span>
    }

    @Test
    public void testDnsMasqConfigCommand() {
<span class="nc" id="L746">        final Answer answer = _resource.executeRequest(generateDnsMasqConfigCommand());</span>
<span class="nc" id="L747">        assertTrue(answer.getResult());</span>
<span class="nc" id="L748">    }</span>

    protected DnsMasqConfigCommand generateDnsMasqConfigCommand() {
<span class="nc" id="L751">        final List&lt;DhcpTO&gt; dhcps = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L752">        dhcps.add(new DhcpTO(&quot;10.1.20.2&quot;, &quot;10.1.20.1&quot;, &quot;255.255.255.0&quot;, &quot;10.1.20.5&quot;));</span>
<span class="nc" id="L753">        dhcps.add(new DhcpTO(&quot;10.1.21.2&quot;, &quot;10.1.21.1&quot;, &quot;255.255.255.0&quot;, &quot;10.1.21.5&quot;));</span>
<span class="nc" id="L754">        final DnsMasqConfigCommand cmd = new DnsMasqConfigCommand(dhcps);</span>
<span class="nc" id="L755">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L756">        return cmd;</span>
    }

    private void verifyArgs(final DnsMasqConfigCommand cmd, final String script, final String args) {
<span class="nc" id="L760">        assertEquals(script, VRScripts.DNSMASQ_CONFIG);</span>
<span class="nc" id="L761">        assertEquals(args, &quot;10.1.20.2:10.1.20.1:255.255.255.0:10.1.20.5-10.1.21.2:10.1.21.1:255.255.255.0:10.1.21.5-&quot;);</span>
<span class="nc" id="L762">    }</span>

    @Test
    public void testLoadBalancerConfigCommand() {
<span class="nc" id="L766">        _count = 0;</span>
<span class="nc" id="L767">        _file = &quot;&quot;;</span>

<span class="nc" id="L769">        Answer answer = _resource.executeRequest(generateLoadBalancerConfigCommand1());</span>
<span class="nc" id="L770">        assertTrue(answer.getResult());</span>

<span class="nc" id="L772">        answer = _resource.executeRequest(generateLoadBalancerConfigCommand2());</span>
<span class="nc" id="L773">        assertTrue(answer.getResult());</span>
<span class="nc" id="L774">    }</span>

    protected LoadBalancerConfigCommand generateLoadBalancerConfigCommand1() {
<span class="nc" id="L777">        final List&lt;LoadBalancerTO&gt; lbs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L778">        final List&lt;LbDestination&gt; dests = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L779">        dests.add(new LbDestination(80, 8080, &quot;10.1.10.2&quot;, false));</span>
<span class="nc" id="L780">        dests.add(new LbDestination(80, 8080, &quot;10.1.10.2&quot;, true));</span>
<span class="nc" id="L781">        lbs.add(new LoadBalancerTO(UUID.randomUUID().toString(), &quot;64.10.1.10&quot;, 80, &quot;tcp&quot;, &quot;algo&quot;, false, false, false, dests));</span>
<span class="nc" id="L782">        final LoadBalancerTO[] arrayLbs = new LoadBalancerTO[lbs.size()];</span>
<span class="nc" id="L783">        lbs.toArray(arrayLbs);</span>
<span class="nc" id="L784">        final NicTO nic = new NicTO();</span>
<span class="nc" id="L785">        final LoadBalancerConfigCommand cmd = new LoadBalancerConfigCommand(arrayLbs, &quot;64.10.2.10&quot;, &quot;10.1.10.2&quot;, &quot;192.168.1.2&quot;, nic, null, &quot;1000&quot;, false);</span>
<span class="nc" id="L786">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_IP, &quot;10.1.10.2&quot;);</span>
<span class="nc" id="L787">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L788">        return cmd;</span>
    }

    protected LoadBalancerConfigCommand generateLoadBalancerConfigCommand2() {
<span class="nc" id="L792">        final List&lt;LoadBalancerTO&gt; lbs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L793">        final List&lt;LbDestination&gt; dests = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L794">        dests.add(new LbDestination(80, 8080, &quot;10.1.10.2&quot;, false));</span>
<span class="nc" id="L795">        dests.add(new LbDestination(80, 8080, &quot;10.1.10.2&quot;, true));</span>
<span class="nc" id="L796">        lbs.add(new LoadBalancerTO(UUID.randomUUID().toString(), &quot;64.10.1.10&quot;, 80, &quot;tcp&quot;, &quot;algo&quot;, false, false, false, dests));</span>
<span class="nc" id="L797">        final LoadBalancerTO[] arrayLbs = new LoadBalancerTO[lbs.size()];</span>
<span class="nc" id="L798">        lbs.toArray(arrayLbs);</span>
<span class="nc" id="L799">        final NicTO nic = new NicTO();</span>
<span class="nc" id="L800">        nic.setIp(&quot;10.1.10.2&quot;);</span>
<span class="nc" id="L801">        final LoadBalancerConfigCommand cmd = new LoadBalancerConfigCommand(arrayLbs, &quot;64.10.2.10&quot;, &quot;10.1.10.2&quot;, &quot;192.168.1.2&quot;, nic, Long.valueOf(1), &quot;1000&quot;, false);</span>
<span class="nc" id="L802">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_IP, &quot;10.1.10.2&quot;);</span>
<span class="nc" id="L803">        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, ROUTERNAME);</span>
<span class="nc" id="L804">        return cmd;</span>
    }

    protected void verifyFile(final LoadBalancerConfigCommand cmd, final String path, final String filename, final String content) {
<span class="nc" id="L808">        _count ++;</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">        switch (_count) {</span>
        case 1:
        case 3:
<span class="nc" id="L812">            _file = path + filename;</span>
<span class="nc" id="L813">            assertEquals(path, &quot;/etc/haproxy/&quot;);</span>
<span class="nc" id="L814">            assertTrue(filename.startsWith(&quot;haproxy.cfg.new&quot;));</span>
<span class="nc" id="L815">            assertEquals(content, &quot;global\n&quot; +</span>
                    &quot;\tlog 127.0.0.1:3914   local0 warning\n&quot; +
                    &quot;\tmaxconn 1000\n&quot; +
                    &quot;\tmaxpipes 250\n&quot; +
                    &quot;\tchroot /var/lib/haproxy\n&quot; +
                    &quot;\tuser haproxy\n&quot; +
                    &quot;\tgroup haproxy\n&quot; +
                    &quot;\tdaemon\n&quot; +
                    &quot;\t \n&quot; +
                    &quot;defaults\n&quot; +
                    &quot;\tlog     global\n&quot; +
                    &quot;\tmode    tcp\n&quot; +
                    &quot;\toption  dontlognull\n&quot; +
                    &quot;\tretries 3\n&quot; +
                    &quot;\toption redispatch\n&quot; +
                    &quot;\toption forwardfor\n&quot; +
                    &quot;\toption forceclose\n&quot; +
                    &quot;\ttimeout connect    5000\n&quot; +
                    &quot;\ttimeout client     50000\n&quot; +
                    &quot;\ttimeout server     50000\n&quot; +
                    &quot;\n&quot; +
                    &quot;listen stats_on_guest 10.1.10.2:8081\n&quot; +
                    &quot;\tmode http\n&quot; +
                    &quot;\toption httpclose\n&quot; +
                    &quot;\tstats enable\n&quot; +
                    &quot;\tstats uri     /admin?stats\n&quot; +
                    &quot;\tstats realm   Haproxy\\ Statistics\n&quot; +
                    &quot;\tstats auth    admin1:AdMiN123\n&quot; +
                    &quot;\n&quot; +
                    &quot;\t \n&quot; +
                    &quot;listen 64_10_1_10-80 64.10.1.10:80\n&quot; +
                    &quot;\tbalance algo\n&quot; +
                    &quot;\tserver 64_10_1_10-80_0 10.1.10.2:80 check\n&quot; +
                    &quot;\tmode http\n&quot; +
                    &quot;\toption httpclose\n&quot; +
                    &quot;\t \n&quot; +
                    &quot;\t \n&quot;);
<span class="nc" id="L852">            break;</span>
        default:
<span class="nc" id="L854">            fail();</span>
        }
<span class="nc" id="L856">    }</span>

    private void verifyArgs(final LoadBalancerConfigCommand cmd, final String script, final String args) {
<span class="nc" id="L859">        _count ++;</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">        switch (_count) {</span>
        case 2:
<span class="nc" id="L862">            assertEquals(script, VRScripts.LB);</span>
<span class="nc" id="L863">            assertEquals(args, &quot; -i 10.1.10.2 -f &quot; + _file + &quot; -a 64.10.1.10:80:, -s 10.1.10.2:8081:0/0:,,&quot;);</span>
<span class="nc" id="L864">            break;</span>
        default:
<span class="nc" id="L866">            fail();</span>
        }
<span class="nc" id="L868">    }</span>

    @Test
    @Ignore(&quot;Ignore this test while we are experimenting with the commands.&quot;)
    public void testAggregationCommands() {
<span class="nc" id="L873">        final List&lt;NetworkElementCommand&gt; cmds = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L874">        final AggregationControlCommand startCmd = new AggregationControlCommand(Action.Start, ROUTERNAME, ROUTERIP, ROUTERGUESTIP);</span>
<span class="nc" id="L875">        cmds.add(startCmd);</span>
<span class="nc" id="L876">        cmds.add(generateIpAssocCommand());</span>
<span class="nc" id="L877">        cmds.add(generateIpAssocVpcCommand());</span>

<span class="nc" id="L879">        cmds.add(generateSetFirewallRulesCommand());</span>

<span class="nc" id="L881">        cmds.add(generateSetPortForwardingRulesCommand());</span>
<span class="nc" id="L882">        cmds.add(generateSetPortForwardingRulesVpcCommand());</span>

<span class="nc" id="L884">        cmds.add(generateCreateIpAliasCommand());</span>
<span class="nc" id="L885">        cmds.add(generateDeleteIpAliasCommand());</span>
<span class="nc" id="L886">        cmds.add(generateDnsMasqConfigCommand());</span>

<span class="nc" id="L888">        cmds.add(generateRemoteAccessVpnCfgCommand1());</span>
<span class="nc" id="L889">        cmds.add(generateRemoteAccessVpnCfgCommand2());</span>
<span class="nc" id="L890">        cmds.add(generateRemoteAccessVpnCfgCommand3());</span>

        //cmds.add(generateLoadBalancerConfigCommand1());
        //cmds.add(generateLoadBalancerConfigCommand2());

<span class="nc" id="L895">        cmds.add(generateSetPortForwardingRulesCommand());</span>
<span class="nc" id="L896">        cmds.add(generateSetPortForwardingRulesVpcCommand());</span>

<span class="nc" id="L898">        cmds.add(generateDhcpEntryCommand1());</span>
<span class="nc" id="L899">        cmds.add(generateDhcpEntryCommand2());</span>
<span class="nc" id="L900">        cmds.add(generateDhcpEntryCommand3());</span>

<span class="nc" id="L902">        cmds.add(generateSavePasswordCommand());</span>
<span class="nc" id="L903">        cmds.add(generateVmDataCommand());</span>

<span class="nc" id="L905">        final AggregationControlCommand finishCmd = new AggregationControlCommand(Action.Finish, ROUTERNAME, ROUTERIP, ROUTERGUESTIP);</span>
<span class="nc" id="L906">        cmds.add(finishCmd);</span>

<span class="nc bnc" id="L908" title="All 2 branches missed.">        for (final NetworkElementCommand cmd : cmds) {</span>
<span class="nc" id="L909">            final Answer answer = _resource.executeRequest(cmd);</span>
<span class="nc" id="L910">            assertTrue(answer.getResult());</span>
        }
<span class="nc" id="L912">    }</span>

    private void verifyArgs(final AggregationControlCommand cmd, final String script, final String args) {
<span class="nc" id="L915">        assertEquals(script, VRScripts.VR_CFG);</span>
<span class="nc" id="L916">        assertTrue(args.startsWith(&quot;-c /var/cache/cloud/VR-&quot;));</span>
<span class="nc" id="L917">        assertTrue(args.endsWith(&quot;.cfg&quot;));</span>
<span class="nc" id="L918">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>cloud-core (18-mrt-2016 13:14:54)</div></body></html>